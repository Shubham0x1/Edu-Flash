<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM-Powered Flashcard Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section, .flashcards-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        select, textarea, input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, textarea:focus, input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            type: password;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .flashcards-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .flashcard {
            min-width: 260px;
            min-height: 180px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(102,126,234,0.08);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }

        .flashcard .flashcard-inner { height: 100%; }
        .section-cards { display: flex; flex-wrap: wrap; gap: 18px; }
        .section-header { margin-bottom: 8px; }

        .flashcard:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: #f0f4f8;
        }

        .flashcard-header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .flashcard-back .flashcard-header {
            background: #48bb78;
        }

        .difficulty-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .difficulty-easy { background: #48bb78; }
        .difficulty-medium { background: #ed8936; }
        .difficulty-hard { background: #e53e3e; }

        .flashcard-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: left;
        }

        .question {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .answer {
            color: #4a5568;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .flip-instruction {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.8rem;
            color: #718096;
            opacity: 0.7;
        }

        .source-line {
            background: #e6fffa;
            color: #065f46;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 8px;
            border-left: 3px solid #10b981;
        }

        .view-mode-toggle {
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-btn {
            padding: 8px 16px;
            margin: 0 5px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }

        .export-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .export-btn {
            padding: 10px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #667eea;
            color: white;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .flashcard.editing {
            background: #f0f4ff !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
        }
        .edit-btn, .done-btn, .cancel-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 7px 18px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
        }
        .edit-btn:hover, .done-btn:hover, .cancel-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        input[type='text'], select, textarea {
            border: 1.5px solid #b3b3e6;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 15px;
            margin-bottom: 6px;
            background: #fff;
        }
        textarea {
            resize: vertical;
        }

        .section-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }
        .flashcard {
            min-width: 280px;
            min-height: 180px;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(102,126,234,0.10);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .flashcard:hover {
            box-shadow: 0 8px 32px rgba(102,126,234,0.18);
            transform: translateY(-2px) scale(1.01);
        }
        .flashcard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 16px 18px 10px 18px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 18px 18px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .difficulty-badge {
            background: #38d39f;
            color: #fff;
            border-radius: 16px;
            padding: 4px 14px;
            font-size: 0.95em;
            font-weight: 600;
            margin-left: 10px;
            box-shadow: 0 1px 4px rgba(56,211,159,0.10);
        }
        .edit-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            z-index: 2;
            background: #fff;
            color: #764ba2;
            border: 1.5px solid #764ba2;
            border-radius: 6px;
            padding: 4px 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
        }
        .edit-btn:hover {
            background: #764ba2;
            color: #fff;
            border: 1.5px solid #764ba2;
        }
        .flashcard-content {
            padding: 22px 18px 18px 18px;
            font-size: 1.13em;
            color: #222;
        }
        .flip-instruction {
            color: #667eea;
            font-size: 0.98em;
            text-align: center;
            margin-top: 18px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 LLM-Powered Flashcard Generator</h1>
            <p>Transform your educational content into interactive flashcards using AI (No API key required!)</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">📚 Input Content</h2>
                
                <div class="input-group">
                    <label for="modelSelect">AI Model:</label>
                    <select id="modelSelect">
                        <option value="gemini">🤖 Google Gemini</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="subject">Subject Category:</label>
                    <select id="subject">
                        <option value="general">General</option>
                        <option value="biology">Biology</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="physics">Physics</option>
                        <option value="history">History</option>
                        <option value="literature">Literature</option>
                        <option value="computer-science">Computer Science</option>
                        <option value="mathematics">Mathematics</option>
                        <option value="psychology">Psychology</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="fileInput">Upload File (.txt, .pdf):</label>
                    <input type="file" id="fileInput" accept=".txt,.pdf">
                </div>

                <div class="input-group">
                    <label for="textInput">Or Paste Content Directly:</label>
                    <textarea id="textInput" placeholder="Paste your educational content here..."></textarea>
                </div>

                <button class="generate-btn" id="generateBtn">
                    🚀 Generate Flashcards
                </button>

                <div class="error-message" id="errorMessage"></div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating flashcards with AI...</p>
                </div>
            </div>

            <div class="flashcards-section">
                <h2 class="section-title">🃏 Generated Flashcards</h2>
                
                <div class="stats" id="stats" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-number" id="totalCards">0</div>
                        <div class="stat-label">Total Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="easyCards">0</div>
                        <div class="stat-label">Easy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="mediumCards">0</div>
                        <div class="stat-label">Medium</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="hardCards">0</div>
                        <div class="stat-label">Hard</div>
                    </div>
                </div>

                <div class="view-mode-toggle" id="viewModeToggle" style="display: none;">
                    <button class="mode-btn active" onclick="setViewMode('flip')">🔄 Flip Cards</button>
                    <button class="mode-btn" onclick="setViewMode('list')">📋 List View</button>
                </div>

                <div class="flashcards-container" id="flashcardsContainer">
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <p>📝 Your generated flashcards will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <h2 class="section-title">📤 Export Options</h2>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportAsJSON()">📄 JSON</button>
                <button class="export-btn" onclick="exportAsCSV()">📊 CSV</button>
                <button class="export-btn" onclick="exportAsAnki()">🎯 Anki</button>
                <button class="export-btn" onclick="exportAsTXT()">📝 TXT</button>
            </div>
            <div id="languageSelectSection">
                <label for="languageSelect" style="font-weight:600;">🌐 Translate Flashcards To:</label>
                <select id="languageSelect" style="margin: 0 10px;">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="hi">Hindi</option>
                    <option value="zh-CN">Chinese (Simplified)</option>
                    <option value="ar">Arabic</option>
                    <option value="ru">Russian</option>
                    <option value="pt">Portuguese</option>
                    <option value="ja">Japanese</option>
                </select>
                <button id="translateBtn">Translate</button>
                <span id="translateStatus" style="margin-left:10px;color:#667eea;"></span>
            </div>
        </div>
    </div>

    <script>
        let flashcards = [];
        let viewMode = 'flip';
        let originalContent = '';
        
        // File handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalContent = e.target.result;
                    document.getElementById('textInput').value = originalContent;
                };
                reader.readAsText(file);
            }
        });

        // Track text input changes
        document.getElementById('textInput').addEventListener('input', function() {
            originalContent = this.value;
        });

        // Generate flashcards
        document.getElementById('generateBtn').addEventListener('click', generateFlashcards);

        async function generateFlashcards() {
            const subject = document.getElementById('subject').value;
            const content = document.getElementById('textInput').value.trim();
            
            if (!content) {
                showError('Please provide content to generate flashcards from');
                return;
            }

            showLoading(true);
            hideError();
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        subject: subject
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate flashcards');
                }

                console.log('Received data:', data);  // Debug log
                
                if (!Array.isArray(data)) {
                    console.error('Invalid response format:', data);  // Debug log
                    throw new Error('Invalid response format from server');
                }

                flashcards = data.map((card, index) => ({
                    id: index + 1,
                    question: card.question || 'No question provided',
                    answer: card.answer || 'No answer provided',
                    difficulty: card.difficulty || 'Medium',
                    topic: card.topic || 'General'
                }));
                
                displayFlashcards();
                updateStats();
                showExportSection();
                
            } catch (error) {
                console.error('Error details:', error);  // Debug log
                showError('Error generating flashcards: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateWithHuggingFace(content, subject) {
            // Use local processing to generate flashcards without API
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const flashcardData = [];
            
            // Create different types of questions
            const questionTypes = [
                { type: 'definition', prefix: 'What is', difficulty: 'Easy' },
                { type: 'explanation', prefix: 'Explain', difficulty: 'Medium' },
                { type: 'application', prefix: 'How does', difficulty: 'Hard' },
                { type: 'comparison', prefix: 'What are the differences between', difficulty: 'Medium' },
                { type: 'process', prefix: 'Describe the process of', difficulty: 'Hard' },
                { type: 'importance', prefix: 'Why is', difficulty: 'Medium' },
                { type: 'function', prefix: 'What is the function of', difficulty: 'Easy' },
                { type: 'cause', prefix: 'What causes', difficulty: 'Medium' },
                { type: 'result', prefix: 'What happens when', difficulty: 'Hard' }
            ];

            // Extract key terms and concepts
            const keyTerms = extractKeyTerms(content, subject);
            
            // Generate questions based on content analysis
            for (let i = 0; i < Math.min(15, keyTerms.length); i++) {
                const term = keyTerms[i];
                const questionType = questionTypes[i % questionTypes.length];
                const relatedSentences = findRelatedSentences(sentences, term);
                
                const question = generateQuestion(term, questionType, subject);
                const answerData = generateAnswer(term, relatedSentences, subject, content);
                const topic = determineTopicFromSubject(subject);
                
                flashcardData.push({
                    question: question,
                    answer: answerData.answer,
                    sourceLine: answerData.sourceLine,
                    difficulty: questionType.difficulty,
                    topic: topic
                });
            }
            
            // Fill remaining slots if needed
            while (flashcardData.length < 15) {
                const randomSentence = sentences[Math.floor(Math.random() * sentences.length)];
                const questionType = questionTypes[flashcardData.length % questionTypes.length];
                const lineNumber = findLineNumber(content, randomSentence.trim());
                
                flashcardData.push({
                    question: `${questionType.prefix} the concept mentioned in: "${randomSentence.trim()}"?`,
                    answer: `Based on the content: ${randomSentence.trim()}`,
                    sourceLine: lineNumber,
                    difficulty: questionType.difficulty,
                    topic: determineTopicFromSubject(subject)
                });
            }
            
            return JSON.stringify(flashcardData);
        }

        function extractKeyTerms(content, subject) {
            // Simple keyword extraction based on frequency and context
            const words = content.toLowerCase().match(/\b[a-z]{4,}\b/g) || [];
            const wordCount = {};
            
            // Count word frequencies
            words.forEach(word => {
                if (!isStopWord(word)) {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                }
            });
            
            // Sort by frequency and return top terms
            return Object.entries(wordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
        }

        function isStopWord(word) {
            const stopWords = ['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'man', 'new', 'now', 'old', 'see', 'two', 'way', 'who', 'boy', 'did', 'its', 'let', 'put', 'say', 'she', 'too', 'use'];
            return stopWords.includes(word);
        }

        function findRelatedSentences(sentences, term) {
            return sentences.filter(sentence => 
                sentence.toLowerCase().includes(term.toLowerCase())
            ).slice(0, 3);
        }

        function generateQuestion(term, questionType, subject) {
            const subjectContext = getSubjectContext(subject);
            
            switch (questionType.type) {
                case 'definition':
                    return `What is ${term}${subjectContext}?`;
                case 'explanation':
                    return `Explain the concept of ${term}${subjectContext}.`;
                case 'application':
                    return `How does ${term} work${subjectContext}?`;
                case 'comparison':
                    return `What are the key characteristics of ${term}${subjectContext}?`;
                case 'process':
                    return `Describe the process involving ${term}${subjectContext}.`;
                case 'importance':
                    return `Why is ${term} important${subjectContext}?`;
                case 'function':
                    return `What is the function of ${term}${subjectContext}?`;
                case 'cause':
                    return `What factors affect ${term}${subjectContext}?`;
                case 'result':
                    return `What happens with ${term}${subjectContext}?`;
                default:
                    return `What do you know about ${term}${subjectContext}?`;
            }
        }

        function generateAnswer(term, relatedSentences, subject, fullContent) {
            let answer = '';
            let sourceLine = null;
            
            if (relatedSentences.length > 0) {
                answer = relatedSentences.join(' ').trim();
                // Find the line number where this answer appears
                sourceLine = findLineNumber(fullContent, relatedSentences[0]);
            } else {
                answer = `${term} is an important concept in ${subject}. Based on the provided content, it relates to the key principles and ideas discussed in the material.`;
                sourceLine = 'Generated from context';
            }
            
            return { answer, sourceLine };
        }

        function findLineNumber(content, searchText) {
            if (!content || !searchText) return 'Unknown';
            
            const lines = content.split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].toLowerCase().includes(searchText.toLowerCase().substring(0, 50))) {
                    return `Line ${i + 1}`;
                }
            }
            return 'Derived from content';
        }

        function getSubjectContext(subject) {
            const contexts = {
                'biology': ' in biological systems',
                'chemistry': ' in chemical processes',
                'physics': ' in physics',
                'history': ' in historical context',
                'literature': ' in literature',
                'computer-science': ' in computer science',
                'mathematics': ' in mathematics',
                'psychology': ' in psychology',
                'general': ''
            };
            return contexts[subject] || '';
        }

        function createPrompt(content, subject) {
            return `You are an expert educational content creator. Generate exactly 15 high-quality flashcards from the following ${subject} content. 

STRICT FORMAT REQUIREMENTS:
- Return ONLY a valid JSON array
- Each flashcard must have: question, answer, difficulty, topic
- Difficulty must be exactly "Easy", "Medium", or "Hard"
- Questions should be clear and concise
- Answers should be comprehensive but not too long
- Cover different aspects of the content
- Ensure factual accuracy

Content:
${content}

Return format (JSON array only):
[
  {
    "question": "What is...?",
    "answer": "The answer explanation...",
    "difficulty": "Medium",
    "topic": "Main topic"
  }
]`;
        }

        async function callOpenAI(apiKey, prompt) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function determineTopicFromSubject(subject) {
            const topics = {
                'biology': 'Life Sciences',
                'chemistry': 'Chemical Sciences',
                'physics': 'Physical Sciences',
                'history': 'Historical Studies',
                'literature': 'Literature & Language',
                'computer-science': 'Computer Science',
                'mathematics': 'Mathematics',
                'psychology': 'Psychology',
                'general': 'General Knowledge'
            };
            return topics[subject] || 'General Knowledge';
        }

        function parseFlashcards(response) {
            try {
                // If response is already an array, return it directly
                if (Array.isArray(response)) {
                    return response.map((card, index) => ({
                        id: index + 1,
                        question: card.question || 'No question provided',
                        answer: card.answer || 'No answer provided',
                        sourceLine: card.sourceLine || 'Unknown',
                        difficulty: card.difficulty || 'Medium',
                        topic: card.topic || 'General'
                    }));
                }

                // If response is a string, try to parse it as JSON
                if (typeof response === 'string') {
                    // Clean the response to extract JSON
                    let cleanResponse = response.trim();
                    
                    // Find JSON array in response
                    const jsonStart = cleanResponse.indexOf('[');
                    const jsonEnd = cleanResponse.lastIndexOf(']') + 1;
                    
                    if (jsonStart === -1 || jsonEnd === 0) {
                        throw new Error('No valid JSON array found in response');
                    }
                    
                    cleanResponse = cleanResponse.substring(jsonStart, jsonEnd);
                    response = JSON.parse(cleanResponse);
                }
                
                // If we get here, response should be an array
                if (!Array.isArray(response)) {
                    throw new Error('Response is not an array');
                }
                
                return response.map((card, index) => ({
                    id: index + 1,
                    question: card.question || 'No question provided',
                    answer: card.answer || 'No answer provided',
                    sourceLine: card.sourceLine || 'Unknown',
                    difficulty: card.difficulty || 'Medium',
                    topic: card.topic || 'General'
                }));
                
            } catch (error) {
                console.error('Parse error:', error);
                console.error('Raw response:', response);
                throw new Error('Failed to parse flashcards: ' + error.message);
            }
        }

        function displayFlashcards() {
            const container = document.getElementById('flashcardsContainer');
            const viewModeToggle = document.getElementById('viewModeToggle');
            
            if (flashcards.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;"><p>No flashcards generated</p></div>';
                viewModeToggle.style.display = 'none';
                return;
            }
            
            viewModeToggle.style.display = 'block';

            // Group flashcards by section
            const sectionGroups = {};
            flashcards.forEach(card => {
                const section = card.section || 'General';
                if (!sectionGroups[section]) sectionGroups[section] = [];
                sectionGroups[section].push(card);
            });
            const sectionOrder = Object.keys(sectionGroups);

            if (viewMode === 'flip') {
                container.innerHTML = sectionOrder.map(section => `
                    <div class="section-group">
                        <div class="section-header" style="background:#e9e9fa;padding:8px 18px;border-radius:8px;margin:18px 0 10px 0;font-weight:700;font-size:1.1em;color:#4a5568;">
                            ${section}
                        </div>
                        <div class="section-cards">
                            ${sectionGroups[section].map(card => `
                                <div class="flashcard" onclick="flipCard(${card.id})">
                                    <div class="flashcard-inner">
                                        <div class="flashcard-front">
                                            <div class="flashcard-header">
                                                <span>Card ${card.id} - ${card.topic || 'No topic'}</span>
                                                <span class="difficulty-badge difficulty-${(card.difficulty||'').toLowerCase()}">${card.difficulty || ''}</span>
                                            </div>
                                            <div class="flashcard-content">
                                                <div class="question">${card.question || '<em>No question</em>'}</div>
                                            </div>
                                            <div class="flip-instruction">Click to reveal answer</div>
                                        </div>
                                        <div class="flashcard-back">
                                            <div class="flashcard-header">
                                                <span>Answer - ${card.topic || 'No topic'}</span>
                                                <span class="difficulty-badge difficulty-${(card.difficulty||'').toLowerCase()}">${card.difficulty || ''}</span>
                                            </div>
                                            <div class="flashcard-content">
                                                <div class="answer">${card.answer || '<em>No answer</em>'}</div>
                                            </div>
                                            <div class="flip-instruction">Click to see question</div>
                                            <div style="margin-top: 10px; text-align: right;">
                                                <button class="edit-btn" onclick="event.stopPropagation(); openEditModal(${card.id});">Edit</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = sectionOrder.map(section => `
                    <div class="section-group">
                        <div class="section-header" style="background:#e9e9fa;padding:8px 18px;border-radius:8px;margin:18px 0 10px 0;font-weight:700;font-size:1.1em;color:#4a5568;">
                            ${section}
                        </div>
                        <div class="section-cards">
                            ${sectionGroups[section].map(card => `
                                <div class="flashcard" style="height: auto; cursor: default;">
                                    <div class="flashcard-header">
                                        <span>Card ${card.id} - ${card.topic || 'No topic'}</span>
                                        <span class="difficulty-badge difficulty-${(card.difficulty||'').toLowerCase()}">${card.difficulty || ''}</span>
                                    </div>
                                    <div class="flashcard-content" style="text-align: left;">
                                        <div class="question" style="margin-bottom: 15px;">Q: ${card.question || '<em>No question</em>'}</div>
                                        <div class="answer" style="margin-bottom: 10px;">A: ${card.answer || '<em>No answer</em>'}</div>
                                    </div>
                                    <div style="margin-top: 10px; text-align: right;">
                                        <button class="edit-btn" onclick="openEditModal(${card.id});">Edit</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        function flipCard(cardId) {
            if (viewMode !== 'flip') return;
            
            const flashcards = document.querySelectorAll('.flashcard');
            const card = flashcards[cardId - 1];
            card.classList.toggle('flipped');
        }

        function setViewMode(mode) {
            viewMode = mode;
            
            // Update button states
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Redisplay flashcards
            displayFlashcards();
        }

        function updateStats() {
            const total = flashcards.length;
            const easy = flashcards.filter(card => card.difficulty === 'Easy').length;
            const medium = flashcards.filter(card => card.difficulty === 'Medium').length;
            const hard = flashcards.filter(card => card.difficulty === 'Hard').length;
            
            document.getElementById('totalCards').textContent = total;
            document.getElementById('easyCards').textContent = easy;
            document.getElementById('mediumCards').textContent = medium;
            document.getElementById('hardCards').textContent = hard;
            document.getElementById('stats').style.display = 'flex';
        }

        function showExportSection() {
            document.getElementById('exportSection').style.display = 'block';
            addLanguageSelector();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('generateBtn').disabled = show;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Export functions
        function exportAsJSON() {
            const data = JSON.stringify(flashcards, null, 2);
            downloadFile(data, 'flashcards.json', 'application/json');
        }

        function exportAsCSV() {
            const headers = ['ID', 'Question', 'Answer', 'Difficulty', 'Topic'];
            const csvContent = [
                headers.join(','),
                ...flashcards.map(card => [
                    card.id,
                    `"${card.question.replace(/"/g, '""')}"`,
                    `"${card.answer.replace(/"/g, '""')}"`,
                    card.difficulty,
                    `"${card.topic.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'flashcards.csv', 'text/csv');
        }

        function exportAsAnki() {
            const ankiContent = flashcards.map(card => 
                `${card.question}\t${card.answer}\t${card.topic}`
            ).join('\n');
            
            downloadFile(ankiContent, 'flashcards_anki.txt', 'text/plain');
        }

        function exportAsTXT() {
            const txtContent = flashcards.map(card => 
                `Card ${card.id} [${card.difficulty}] - ${card.topic}\nQ: ${card.question}\nA: ${card.answer}\n\n`
            ).join('');
            
            downloadFile(txtContent, 'flashcards.txt', 'text/plain');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Demo content for testing
        function loadDemoContent() {
            document.getElementById('textInput').value = `
Photosynthesis is the process by which plants convert light energy into chemical energy. This process occurs in the chloroplasts of plant cells, specifically in structures called thylakoids. The overall equation for photosynthesis is: 6CO2 + 6H2O + light energy → C6H12O6 + 6O2.

The process consists of two main stages: the light-dependent reactions and the light-independent reactions (Calvin cycle). In the light-dependent reactions, chlorophyll absorbs light energy and converts it into ATP and NADPH. These reactions also produce oxygen as a byproduct.

The Calvin cycle uses the ATP and NADPH produced in the light reactions to convert carbon dioxide into glucose. This process does not directly require light but depends on the products of the light reactions.

Factors affecting photosynthesis include light intensity, carbon dioxide concentration, temperature, and water availability. Understanding photosynthesis is crucial for comprehending how energy flows through ecosystems.
            `;
            originalContent = document.getElementById('textInput').value;
            document.getElementById('subject').value = 'biology';
        }

        // Add demo button (for testing purposes)
        document.addEventListener('DOMContentLoaded', function() {
            const demoBtn = document.createElement('button');
            demoBtn.textContent = '📖 Load Demo Content';
            demoBtn.className = 'export-btn';
            demoBtn.style.marginTop = '10px';
            demoBtn.onclick = loadDemoContent;
            document.querySelector('.input-section').appendChild(demoBtn);
        });

        // Remove the local processing option from the model selector
        document.addEventListener('DOMContentLoaded', function() {
            const modelSelect = document.getElementById('modelSelect');
            if (modelSelect) {
                modelSelect.innerHTML = '<option value="gemini">🤖 Google Gemini</option>';
            }
        });

        function openEditModal(cardId) {
            const card = flashcards.find(c => c.id === cardId);
            const modal = document.getElementById('editModal');
            const modalCard = document.getElementById('editModalCard');
            modalCard.innerHTML = `
                <div class="flashcard-header">
                    <span>Edit Card ${card.id} - <input type='text' value="${card.topic}" id="edit-topic-modal" style="width: 150px;" /></span>
                    <select id="edit-difficulty-modal">
                        <option value="Easy" ${card.difficulty === 'Easy' ? 'selected' : ''}>Easy</option>
                        <option value="Medium" ${card.difficulty === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Hard" ${card.difficulty === 'Hard' ? 'selected' : ''}>Hard</option>
                    </select>
                </div>
                <div class="flashcard-content">
                    <div class="question"><textarea id="edit-question-modal" style="width: 100%; min-height: 40px;">${card.question}</textarea></div>
                    <div class="answer"><textarea id="edit-answer-modal" style="width: 100%; min-height: 40px;">${card.answer}</textarea></div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="done-btn" onclick="saveEditModal(${card.id})">Done</button>
                    <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                </div>
            `;
            modal.classList.add('show');
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.remove('hide'); }, 10);
            document.getElementById('editModalOverlay').onclick = closeEditModal;
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hide');
            setTimeout(() => { modal.style.display = 'none'; modal.classList.remove('show'); }, 250);
        }

        function saveEditModal(cardId) {
            const question = document.getElementById('edit-question-modal').value;
            const answer = document.getElementById('edit-answer-modal').value;
            const difficulty = document.getElementById('edit-difficulty-modal').value;
            const topic = document.getElementById('edit-topic-modal').value;
            flashcards = flashcards.map(card => card.id === cardId ? {
                ...card,
                question,
                answer,
                difficulty,
                topic
            } : card);
            closeEditModal();
            displayFlashcards();
        }

        // Ensure Translate button is always bound after DOM is loaded and after dynamic insertion
        function bindTranslateButton() {
            const translateBtn = document.getElementById('translateBtn');
            if (translateBtn) {
                translateBtn.onclick = translateAllFlashcards;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            bindTranslateButton();
        });

        // If you dynamically add the language selector, call bindTranslateButton after insertion
        function addLanguageSelector() {
            const exportSection = document.getElementById('exportSection');
            if (!document.getElementById('languageSelect')) {
                const langDiv = document.createElement('div');
                langDiv.style.margin = '20px 0';
                langDiv.innerHTML = `
                    <label for="languageSelect" style="font-weight:600;">🌐 Translate Flashcards To:</label>
                    <select id="languageSelect" style="margin: 0 10px;">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="hi">Hindi</option>
                        <option value="zh-CN">Chinese (Simplified)</option>
                        <option value="ar">Arabic</option>
                        <option value="ru">Russian</option>
                        <option value="pt">Portuguese</option>
                        <option value="ja">Japanese</option>
                    </select>
                    <button id="translateBtn">Translate</button>
                    <span id="translateStatus" style="margin-left:10px;color:#667eea;"></span>
                `;
                exportSection.insertBefore(langDiv, exportSection.firstChild);
                bindTranslateButton();
            }
        }

        async function translateAllFlashcards() {
            console.log('Translate button clicked'); // Debug log
            const lang = document.getElementById('languageSelect').value;
            const translateBtn = document.getElementById('translateBtn');
            const statusEl = document.getElementById('translateStatus');
            translateBtn.disabled = true;
            statusEl.textContent = 'Translating...';
            statusEl.style.color = '#667eea';
            let success = true;
            for (let i = 0; i < flashcards.length; i++) {
                try {
                    flashcards[i].question = await translateText(flashcards[i].question, lang);
                    flashcards[i].answer = await translateText(flashcards[i].answer, lang);
                    flashcards[i].topic = await translateText(flashcards[i].topic, lang);
                } catch (e) {
                    success = false;
                    break;
                }
            }
            if (success) {
                statusEl.textContent = 'Translation complete!';
                statusEl.style.color = '#38d39f';
                displayFlashcards();
            } else {
                statusEl.textContent = 'Translation failed. Please try again later.';
                statusEl.style.color = '#e53e3e';
            }
            translateBtn.disabled = false;
        }

        async function translateText(text, targetLang) {
            if (!text) return '';
            try {
                const res = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, targetLang })
                });
                if (!res.ok) throw new Error('Backend translation error');
                const data = await res.json();
                if (data.translated) {
                    return data.translated;
                } else {
                    throw new Error(data.error || 'No translation');
                }
            } catch (e) {
                return text;
            }
        }

        // Add question search bar above content input
        function addQuestionSearchBar() {
            const inputSection = document.querySelector('.input-section');
            if (!document.getElementById('questionSearchBar')) {
                const searchDiv = document.createElement('div');
                searchDiv.id = 'questionSearchBar';
                searchDiv.style.marginBottom = '22px';
                searchDiv.innerHTML = `
                    <label for="searchQuestionInput" style="font-weight:600;">🔍 Search for an answer in your content:</label>
                    <div style="display:flex;gap:10px;margin-top:8px;">
                        <input id="searchQuestionInput" type="text" placeholder="Type your question..." style="flex:1;padding:10px 12px;font-size:1em;border-radius:7px;border:1.5px solid #b3b3e6;" />
                        <button id="searchQuestionBtn" style="padding:10px 22px;font-size:1em;border-radius:7px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-weight:600;border:none;cursor:pointer;">Search Answer</button>
                    </div>
                    <div id="searchAnswerCard" style="margin-top:18px;"></div>
                `;
                inputSection.insertBefore(searchDiv, inputSection.firstChild);
                document.getElementById('searchQuestionBtn').onclick = searchAnswerFromContent;
            }
        }
        addQuestionSearchBar();

        async function searchAnswerFromContent() {
            const question = document.getElementById('searchQuestionInput').value.trim();
            const content = document.getElementById('textInput').value.trim();
            const answerCard = document.getElementById('searchAnswerCard');
            answerCard.innerHTML = '';
            if (!question) {
                answerCard.innerHTML = '<div style="color:#e53e3e;font-weight:600;">Please enter a question.</div>';
                return;
            }
            if (!content) {
                answerCard.innerHTML = '<div style="color:#e53e3e;font-weight:600;">Please provide content to search in.</div>';
                return;
            }
            answerCard.innerHTML = '<div style="color:#667eea;">Searching for answer...</div>';
            try {
                const res = await fetch('/api/search-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, content })
                });
                const data = await res.json();
                if (res.ok && data.answer) {
                    answerCard.innerHTML = `<div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(102,126,234,0.08);padding:22px 18px 18px 18px;margin-top:0;">
                        <div style="font-weight:700;font-size:1.08em;color:#764ba2;margin-bottom:8px;">Answer</div>
                        <div style="font-size:1.13em;color:#222;">${data.answer}</div>
                    </div>`;
                } else {
                    answerCard.innerHTML = `<div style="color:#e53e3e;font-weight:600;">${data.error || 'No answer found.'}</div>`;
                }
            } catch (e) {
                answerCard.innerHTML = '<div style="color:#e53e3e;font-weight:600;">Error searching for answer.</div>';
            }
        }
    </script>

    <!-- Add modal HTML to the body -->
    <div id="editModal" style="display: none;">
        <div id="editModalOverlay"></div>
        <div id="editModalContent">
            <div class="flashcard editing" id="editModalCard"></div>
        </div>
    </div>

    <!-- Add modal styles and transitions -->
    <style>
        #editModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.35);
            transition: background 0.3s;
        }
        #editModalOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 1;
        }
        #editModalContent {
            position: relative;
            z-index: 2;
            animation: modalPopIn 0.35s cubic-bezier(.4,2,.6,1) forwards;
            transform: scale(0.95);
            opacity: 0;
        }
        #editModal.show #editModalContent {
            animation: modalPopIn 0.35s cubic-bezier(.4,2,.6,1) forwards;
        }
        @keyframes modalPopIn {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        #editModal.hide #editModalContent {
            animation: modalPopOut 0.25s cubic-bezier(.4,2,.6,1) forwards;
        }
        @keyframes modalPopOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0; }
        }
    </style>
</body>
</html>